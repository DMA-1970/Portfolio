name: Traffic Monitor

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/traffic-monitor.yml'

jobs:
  monitor-traffic:
    name: Monitor Portfolio Traffic
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Get GitHub Repository Traffic
      id: repo_traffic
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "üìä Checking GitHub repository traffic..."
        
        # Get repository views (clones, views, etc.)
        REPO_NAME="${{ github.repository }}"
        
        echo "Repository: $REPO_NAME"
        echo "Checking traffic data..."
        
        # Initialize report
        echo "# Traffic Report" > traffic-report.md
        echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> traffic-report.md
        echo "" >> traffic-report.md
        
        # Get repository views
        echo "## Repository Analytics" >> traffic-report.md
        VIEWS_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/$REPO_NAME/traffic/views" 2>/dev/null || echo '{"count":0,"uniques":0}')
        
        echo "$VIEWS_RESPONSE" > views.json
        
        # Extract views data
        VIEWS_COUNT=$(echo "$VIEWS_RESPONSE" | grep -o '"count":[0-9]*' | head -1 | sed 's/"count"://' || echo "0")
        UNIQUE_VIEWS=$(echo "$VIEWS_RESPONSE" | grep -o '"uniques":[0-9]*' | head -1 | sed 's/"uniques"://' || echo "0")
        
        echo "üìà Total Views: $VIEWS_COUNT" >> traffic-report.md
        echo "üë• Unique Visitors: $UNIQUE_VIEWS" >> traffic-report.md
        
        # Get repository clones
        CLONES_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/$REPO_NAME/traffic/clones" 2>/dev/null || echo '{"count":0,"uniques":0}')
        
        echo "$CLONES_RESPONSE" > clones.json
        
        CLONES_COUNT=$(echo "$CLONES_RESPONSE" | grep -o '"count":[0-9]*' | head -1 | sed 's/"count"://' || echo "0")
        UNIQUE_CLONES=$(echo "$CLONES_RESPONSE" | grep -o '"uniques":[0-9]*' | head -1 | sed 's/"uniques"://' || echo "0")
        
        echo "üì• Total Clones: $CLONES_COUNT" >> traffic-report.md
        echo "üë§ Unique Cloners: $UNIQUE_CLONES" >> traffic-report.md
        echo "" >> traffic-report.md
        
    - name: Check Site Uptime
      run: |
        echo "üåê Checking site uptime and response time..."
        SITE_URL="https://dma-1970.github.io/Portfolio/index.html"
        
        echo "" >> traffic-report.md
        echo "## Site Health Check" >> traffic-report.md
        
        # Check if site is up
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$SITE_URL" || echo "000")
        RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" --max-time 10 "$SITE_URL" || echo "0")
        CONTENT_SIZE=$(curl -s -o /dev/null -w "%{size_download}" --max-time 10 "$SITE_URL" || echo "0")
        
        echo "Status Code: $HTTP_CODE" >> traffic-report.md
        echo "Response Time: ${RESPONSE_TIME}s" >> traffic-report.md
        PAGE_SIZE_KB=$(awk "BEGIN {printf \"%.2f\", $CONTENT_SIZE/1024}")
        echo "Page Size: ${PAGE_SIZE_KB} KB" >> traffic-report.md
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "‚úÖ Site Status: ONLINE" >> traffic-report.md
          echo "‚úÖ Site is UP"
        else
          echo "‚ùå Site Status: OFFLINE or ERROR (HTTP $HTTP_CODE)" >> traffic-report.md
          echo "‚ö†Ô∏è Site may be DOWN or slow (HTTP $HTTP_CODE)"
        fi
        echo "" >> traffic-report.md
        
    - name: Check Popular Pages
      run: |
        echo "üìÑ Checking popular pages..."
        echo "## Page Accessibility Check" >> traffic-report.md
        
        PAGES=("index.html" "cv.html" "Module1.html" "Module2.html" "Module3.html" "Module4.html" "Module5.html" "Module6.html" "Module7.html" "continuous-development.html")
        
        ACCESSIBLE=0
        TOTAL=${#PAGES[@]}
        
        for page in "${PAGES[@]}"; do
          URL="https://dma-1970.github.io/Portfolio/$page"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 "$URL" || echo "000")
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" --max-time 5 "$URL" || echo "0")
          
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ $page - Accessible (${RESPONSE_TIME}s)" >> traffic-report.md
            ACCESSIBLE=$((ACCESSIBLE + 1))
          else
            echo "‚ùå $page - HTTP $STATUS" >> traffic-report.md
          fi
        done
        
        echo "" >> traffic-report.md
        echo "**Accessibility Score: $ACCESSIBLE/$TOTAL pages**" >> traffic-report.md
        echo "" >> traffic-report.md
        
    - name: Generate Traffic Summary
      run: |
        echo "# Traffic Monitor Report" > traffic-summary.md
        echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> traffic-summary.md
        echo "" >> traffic-summary.md
        
        if [ -f traffic-report.md ]; then
          cat traffic-report.md >> traffic-summary.md
        fi
        
        echo "" >> traffic-summary.md
        echo "---" >> traffic-summary.md
        echo "This report is generated automatically every 6 hours." >> traffic-summary.md
        
        cat traffic-summary.md
        
    - name: Upload Traffic Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: traffic-report-$(date +%Y%m%d-%H%M%S)
        path: |
          traffic-summary.md
          traffic-report.md
          views.json
          clones.json
        retention-days: 90
        
    - name: Create Traffic Log
      run: |
        mkdir -p .github/traffic-logs
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        if [ -f traffic-summary.md ]; then
          cp traffic-summary.md ".github/traffic-logs/traffic-$TIMESTAMP.md"
        fi
        
    - name: Commit Traffic Logs (if changed)
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .github/traffic-logs/ || true
        git diff --staged --quiet || git commit -m "Update traffic logs [skip ci]" || true
        git push || true
        
    - name: Prepare Email Content
      run: |
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        if [ -f traffic-summary.md ]; then
          # Escape HTML for email
          sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' traffic-summary.md > email-body.txt
        else
          echo "No traffic summary available" > email-body.txt
        fi
        
    - name: Send Email Report
      if: always() && secrets.SMTP_SERVER != ''
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "Portfolio Traffic Report - ${{ env.TIMESTAMP }}"
        to: david@abiodun.co.uk
        from: GitHub Actions <${{ secrets.SMTP_USERNAME }}>
        body: |
          Hi David,
          
          Your Portfolio traffic monitoring report is ready.
          
          $(cat traffic-summary.md)
          
          ---
          This is an automated report from your GitHub Actions workflow.
          View full details: https://github.com/${{ github.repository }}/actions
        html_body: |
          <html>
          <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
            <h2 style="color: #0366d6;">Portfolio Traffic Report</h2>
            <p>Hi David,</p>
            <p>Your Portfolio traffic monitoring report is ready.</p>
            <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px; border-left: 4px solid #0366d6; margin: 20px 0;">
              <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; margin: 0;">$(cat traffic-summary.md)</pre>
            </div>
            <hr style="border: none; border-top: 1px solid #e1e4e8; margin: 20px 0;">
            <p style="font-size: 12px; color: #6a737d;">
              This is an automated report from your GitHub Actions workflow.<br>
              <a href="https://github.com/${{ github.repository }}/actions" style="color: #0366d6;">View full details on GitHub</a>
            </p>
          </body>
          </html>
        attachments: traffic-summary.md,traffic-report.md

  quick-check:
    name: Quick Traffic Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - name: Quick Site Check
      run: |
        echo "üîç Quick traffic check..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 "https://dma-1970.github.io/Portfolio/index.html" || echo "000")
        if [ "$HTTP_CODE" = "200" ]; then
          echo "‚úÖ Site is accessible"
        else
          echo "‚ö†Ô∏è Site check returned HTTP $HTTP_CODE"
        fi

